name: Job Finder Automation

on:
  workflow_dispatch:
    inputs:
      search_query:
        description: "Search Query"
        required: false
        type: string
      locations:
        description: "Locations (JSON list or single string)"
        required: false
        type: string
      max_pages:
        description: "Max Pages per Location"
        required: false
        type: string
      min_salary:
        description: "Minimum Salary"
        required: false
        type: string
      max_days_old:
        description: "Max Days Old"
        required: false
        type: string
      blacklist_companies:
        description: "Blacklist Companies (JSON list or comma-separated)"
        required: false
        type: string
      exclude_keywords:
        description: "Exclude Keywords (JSON list or comma-separated)"
        required: false
        type: string
      google_domain:
        description: "Google Domain"
        required: false
        type: string
      gl:
        description: "GL (Country Code)"
        required: false
        type: string
      hl:
        description: "HL (Language Code)"
        required: false
        type: string
  schedule:
    - cron: "0 14 * * 6"

permissions:
  issues: write
  contents: write

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.14.0"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fetch History
        continue-on-error: true
        run: |
          # Try to fetch the history file from the orphan branch
          git fetch origin job-history-data:job-history-data
          git checkout job-history-data -- data/history.json

      - name: Run script
        env:
          API_KEY: ${{ secrets.API_KEY }}
          SEARCH_QUERY: ${{ inputs.search_query || vars.SEARCH_QUERY }}
          LOCATIONS: ${{ inputs.locations || vars.LOCATIONS }}
          MAX_PAGES: ${{ inputs.max_pages || vars.MAX_PAGES }}
          MIN_SALARY: ${{ inputs.min_salary || vars.MIN_SALARY }}
          MAX_DAYS_OLD: ${{ inputs.max_days_old || vars.MAX_DAYS_OLD }}
          BLACKLIST_COMPANIES: ${{ inputs.blacklist_companies || vars.BLACKLIST_COMPANIES }}
          EXCLUDE_KEYWORDS: ${{ inputs.exclude_keywords || vars.EXCLUDE_KEYWORDS }}
          GOOGLE_DOMAIN: ${{ inputs.google_domain || vars.GOOGLE_DOMAIN }}
          GL: ${{ inputs.gl || vars.GL }}
          HL: ${{ inputs.hl || vars.HL }}
        run: |
          echo "Running with the following configuration:"
          echo "SEARCH_QUERY: $SEARCH_QUERY"
          echo "LOCATIONS: $LOCATIONS"
          echo "MAX_PAGES: $MAX_PAGES"
          echo "MIN_SALARY: $MIN_SALARY"
          echo "MAX_DAYS_OLD: $MAX_DAYS_OLD"
          echo "BLACKLIST_COMPANIES: $BLACKLIST_COMPANIES"
          echo "EXCLUDE_KEYWORDS: $EXCLUDE_KEYWORDS"
          echo "GOOGLE_DOMAIN: $GOOGLE_DOMAIN"
          echo "GL: $GL"
          echo "HL: $HL"
          python src/main.py

      - name: Upload jobs.json
        uses: actions/upload-artifact@v4
        with:
          name: jobs-json
          path: jobs.json

      - name: Commit and Push History
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # Save the new history file to a temp location
          cp data/history.json /tmp/history.json

          # Switch to the data branch (create if it doesn't exist)
          if git rev-parse --verify job-history-data; then
            git checkout job-history-data
            git pull origin job-history-data || echo "Branch might be new"
          else
            git checkout --orphan job-history-data
            git rm -rf .
          fi

          # Restore the file
          mkdir -p data
          cp /tmp/history.json data/history.json

          # Commit and push
          git add data/history.json
          if git diff --staged --quiet; then
            echo "No changes to history."
          else
            git commit -m "Update job history"
            git push origin job-history-data
          fi

      - name: Create GitHub Issue
        id: create-issue
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: Weekly Job Search Results
          content-filepath: ./jobs.md
          labels: Automation-Email
          assignees: HarshPanchal01, anmolp476

      - name: Close created issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh issue close ${{ steps.create-issue.outputs.issue-number }} --comment "Closing automatically to keep issue tracker clean."
