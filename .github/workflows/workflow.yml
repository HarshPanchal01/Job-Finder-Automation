name: Job Finder Automation

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      search_queries:
        description: "Search Queries (JSON list or comma-separated)"
        required: false
        type: string
      locations:
        description: "Locations (JSON list or single string)"
        required: false
        type: string
      max_pages:
        description: "Max Pages per Location"
        required: false
        type: string
      min_salary:
        description: "Minimum Salary"
        required: false
        type: string
      max_days_old:
        description: "Max Days Old"
        required: false
        type: string
      blacklist_companies:
        description: "Blacklist Companies (JSON list or comma-separated)"
        required: false
        type: string
      exclude_keywords:
        description: "Exclude Keywords (JSON list or comma-separated)"
        required: false
        type: string
      schedule_types:
        description: "Schedule Types (JSON list or comma-separated)"
        required: false
        type: string
      trusted_domains:
        description: "Trusted Domains (JSON list or comma-separated)"
        required: false
        type: string
      google_domain:
        description: "Google Domain"
        required: false
        type: string
      gl:
        description: "GL (Country Code)"
        required: false
        type: string
      hl:
        description: "HL (Language Code)"
        required: false
        type: string

permissions:
  issues: write
  contents: write

jobs:
  run-script:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      # Python setup is no longer needed as we use Docker
      # - name: Set up Python...
      # - name: Install dependencies...

      - name: Fetch History
        continue-on-error: true
        run: |
          # Try to fetch the history file from the orphan branch
          git fetch origin job-history-data:job-history-data
          git checkout job-history-data -- data/history.json

      - name: Build Docker Image
        run: docker build -t job-finder .

      - name: Run Automation in Docker
        env:
          API_KEY: ${{ secrets.API_KEY }}
          SEARCH_QUERIES: ${{ inputs.search_queries || vars.SEARCH_QUERIES }}
          LOCATIONS: ${{ inputs.locations || vars.LOCATIONS }}
          MAX_PAGES: ${{ inputs.max_pages || vars.MAX_PAGES }}
          MIN_SALARY: ${{ inputs.min_salary || vars.MIN_SALARY }}
          MAX_DAYS_OLD: ${{ inputs.max_days_old || vars.MAX_DAYS_OLD }}
          BLACKLIST_COMPANIES: ${{ inputs.blacklist_companies || vars.BLACKLIST_COMPANIES }}
          EXCLUDE_KEYWORDS: ${{ inputs.exclude_keywords || vars.EXCLUDE_KEYWORDS }}
          SCHEDULE_TYPES: ${{ inputs.schedule_types || vars.SCHEDULE_TYPES }}
          TRUSTED_DOMAINS: ${{ inputs.trusted_domains || vars.TRUSTED_DOMAINS }}
          GOOGLE_DOMAIN: ${{ inputs.google_domain || vars.GOOGLE_DOMAIN }}
          GL: ${{ inputs.gl || vars.GL }}
          HL: ${{ inputs.hl || vars.HL }}
        run: |
          # Create a .env file to pass variables easily to Docker
          echo "API_KEY=$API_KEY" >> .env
          echo "SEARCH_QUERIES=$SEARCH_QUERIES" >> .env
          echo "LOCATIONS=$LOCATIONS" >> .env
          echo "MAX_PAGES=$MAX_PAGES" >> .env
          echo "MIN_SALARY=$MIN_SALARY" >> .env
          echo "MAX_DAYS_OLD=$MAX_DAYS_OLD" >> .env
          echo "BLACKLIST_COMPANIES=$BLACKLIST_COMPANIES" >> .env
          echo "EXCLUDE_KEYWORDS=$EXCLUDE_KEYWORDS" >> .env
          echo "SCHEDULE_TYPES=$SCHEDULE_TYPES" >> .env
          echo "TRUSTED_DOMAINS=$TRUSTED_DOMAINS" >> .env
          echo "GOOGLE_DOMAIN=$GOOGLE_DOMAIN" >> .env
          echo "GL=$GL" >> .env
          echo "HL=$HL" >> .env

          # Run the container
          # -v ${{ github.workspace }}:/app maps the current runner directory to /app in container
          # This ensures jobs.json and history.json are written back to the runner's file system
          docker run --rm -v ${{ github.workspace }}:/app --env-file .env job-finder

      - name: Fix File Permissions
        if: always()
        run: |
          # Docker runs as root, so files created/modified (like jobs.json) might be owned by root.
          # We change ownership back to the runner user so the upload/commit steps work.
          sudo chown -R $USER:$USER .

      - name: Upload Job Reports
        uses: actions/upload-artifact@v4
        with:
          name: job-reports
          path: |
            jobs.json
            jobs.md

      - name: Commit and Push History
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # Save the new history file to a temp location
          cp data/history.json /tmp/history.json

          # Switch to the data branch (create if it doesn't exist)
          if git rev-parse --verify job-history-data; then
            git checkout job-history-data
            git pull origin job-history-data || echo "Branch might be new"
          else
            git checkout --orphan job-history-data
            git rm -rf .
          fi

          # Restore the file
          mkdir -p data
          cp /tmp/history.json data/history.json

          # Commit and push
          git add data/history.json
          if git diff --staged --quiet; then
            echo "No changes to history."
          else
            git commit -m "Update job history"
            git push origin job-history-data
          fi

      - name: Create GitHub Issue
        id: create-issue
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: Weekly Job Search Results
          content-filepath: ./summary.md
          labels: Automation-Email
          assignees: HarshPanchal01, anmolp476, JamesMeta

      - name: Close created issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh issue close ${{ steps.create-issue.outputs.issue-number }} --comment "Closing automatically to keep issue tracker clean."
